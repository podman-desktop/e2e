# Copyright (C) 2025 Red Hat, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: 'Check instance system info'
description: 'Check the system information of the instance'

outputs:
  system-info:
    description: 'The system information of the instance'

runs:
  using: 'composite'
  steps:
    - name: 'Execute systeminfo command on remote host'
      shell: bash
      run: |
        # Check if required files exist before proceeding
        if [ ! -f "host" ] || [ ! -f "username" ] || [ ! -f "id_rsa" ]; then
          echo "::error::Connection files (host, username, id_rsa) not found in the workspace."
          exit 1
        fi

        # Read host and username from files
        SSH_HOST=$(cat host)
        SSH_USER=$(cat username)

        echo "Connecting to ${SSH_USER}@${SSH_HOST} to run systeminfo..."

        # Run the ssh command using the id_rsa file directly
        SYSTEM_INFO=$(ssh -i id_rsa \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o ServerAliveInterval=30 \
          -o ServerAliveCountMax=1200 \
          ${SSH_USER}@${SSH_HOST} "systeminfo")

        if [ $? -ne 0 ]; then
          echo "::error::Failed to connect or execute command on the remote host."
          exit 1
        fi

        echo "System Information:"
        echo "$SYSTEM_INFO"

        # Set the action's output
        echo "system-info<<EOF" >> $GITHUB_OUTPUT
        echo "$SYSTEM_INFO" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT